# Mapping Module

Модуль `app/mapping` отвечает за применение пользовательских правил преобразования (маппинга) данных к загруженным таблицам. Используется на этапе валидации и стандартизации данных.

## Назначение

* Позволяет пользователям описывать правила переименования, приведения типов и трансформаций столбцов в формате JSON.
* Преобразует `DataFrame` с данными согласно этим правилам.

## Структура

### 1. `schemas.py`

Определяет структуры `MappingRule` и `MappingConfig` для валидации JSON-конфига.

### 2. `transforms.py`

Содержит словарь предопределённых строковых трансформаций (например, `trim`, `upper`).

### 3. `engine.py`

Основная логика применения маппинга:

* перебирает правила из `MappingConfig`
* применяет трансформации и преобразования типов
* возвращает новый `DataFrame`

### 4. `storage.py`

Хранит и загружает конфиги маппинга из JSON-файлов (`config/<project_id>.json`).

### 5. `router.py`

REST API для получения и сохранения конфигов:

* `GET  /mapping?project_id=...` — вернуть конфиг проекта
* `POST /mapping` — сохранить или обновить конфиг

### 6. `test_engine.py`

Покрытие базового применения маппинга через `pytest`.

## Пример JSON-конфига

```json
{
  "project_id": "demo",
  "rules": [
    {
      "source": "customer_name",
      "target": "name",
      "transform": "trim",
      "type": "string"
    },
    {
      "source": "amount",
      "target": "total",
      "type": "float"
    }
  ]
}
```

## Возможности и ограничения

* Поддерживаются только предопределённые трансформации (см. `transforms.py`).
* При ошибке преобразования — значение превращается в `NaN` (без исключений).
* Не реализована валидация дубликатов целевых столбцов (TODO).

## Зависимости

* `pandas`, `slugify`, `pydantic`

## Использование

```python
from app.mapping.engine import apply_mapping
from app.mapping.storage import load_config

cfg = load_config("project123")
df = apply_mapping(df_raw, cfg)
```

---

Для добавления новых типов трансформаций — расширьте `transforms.py` и скорректируйте `engine.py`.
