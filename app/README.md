# Mapping¬†Service

**Mapping¬†Service**¬†‚Äî —ç—Ç–æ –º–∏–Ω–∏‚ÄëETL‚Äë–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (CSV/XLSX/JSON), –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏—Ö –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º—É –º–∞–ø–ø–∏–Ω–≥—É, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ –≤–Ω–µ—à–Ω–∏–π REST¬†API.

<div align="center">
<b>RAW¬†file ‚ûú Parser¬†‚ûú Mapping¬†‚ûú Quality¬†‚ûú Sender¬†‚ûú External¬†API</b>
</div>

---

## ‚ú®¬†–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –®–∞–≥            | –ú–æ–¥—É–ª—å    | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                                                                                 |
| -------------- | --------- | ---------------------------------------------------------------------------------------------------------- |
| **–ó–∞–≥—Ä—É–∑–∫–∞**   | `upload`  | –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–π–ª (—Ñ–æ—Ä–º–æ–π –∏–ª–∏ –∏–∑ S3), —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `uploads/<project_id>/`, –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `file_received`. |
| **–ü–∞—Ä—Å–∏–Ω–≥**    | `parser`  | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç, —á–∏—Ç–∞–µ—Ç –≤ `pandas.DataFrame`.                                                            |
| **–ú–∞–ø–ø–∏–Ω–≥**    | `mapping` | –ü—Ä–∏–º–µ–Ω—è–µ—Ç JSON‚Äë–∫–æ–Ω—Ñ–∏–≥:¬†–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —Ç–∏–ø–∏–∑–∞—Ü–∏—è, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫.                                     |
| **–ö–∞—á–µ—Å—Ç–≤–æ**   | `quality` | –ü—Ä–æ–≤–µ—Ä–∫–∏ (–ø—Ä–æ–ø—É—Å–∫–∏, —Ç–∏–ø—ã, –¥–∏–∞–ø–∞–∑–æ–Ω—ã). –§–æ—Ä–º–∏—Ä—É–µ—Ç `reports/<project_id>/quality_report.csv`.                 |
| **–û—Ç–ø—Ä–∞–≤–∫–∞**   | `sender`  | –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç DataFrame –≤ JSON, —à–ª—ë—Ç –≤–æ –≤–Ω–µ—à–Ω–∏–π API —Å —Ä–µ—Ç—Ä–∞—è–º–∏ –∏ backoff‚Äô–æ–º.                                |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** | `project` | CRUD –ø—Ä–æ–µ–∫—Ç–æ–≤, –≤—ã–¥–∞—á–∞ API‚Äë–∫–ª—é—á–µ–π, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–π–Ω—Ç–∞—Ö.                               |

---

## üóÇÔ∏è¬†–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```
Mapping_Service/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ core/           # –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (pydantic‚ÄëBaseSettings)
‚îÇ   ‚îú‚îÄ‚îÄ project/        # —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ (CRUD, auth)
‚îÇ   ‚îú‚îÄ‚îÄ upload/         # –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ + —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
‚îÇ   ‚îú‚îÄ‚îÄ parser/         # —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ DataFrame
‚îÇ   ‚îú‚îÄ‚îÄ mapping/        # –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –º–∞–ø–ø–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ quality/        # –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –æ—Ç—á—ë—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ sender/         # –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ä—É–∂—É
‚îÇ   ‚îî‚îÄ‚îÄ auth/           # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å get_current_project
‚îú‚îÄ‚îÄ templates/          # –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π UI (HTMX + Pico.css)
‚îú‚îÄ‚îÄ uploads/            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã (git‚Äëignored)
‚îú‚îÄ‚îÄ reports/            # quality‚Äë–æ—Ç—á—ë—Ç—ã (git‚Äëignored)
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md           # —ç—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üöÄ¬†–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏ —Å–æ–∑–¥–∞—ë–º venv
python -m venv .venv && source .venv/bin/activate

# 2. –°—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# 3. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º)
export SENDER_ENDPOINT=https://example.com/api/v1/upload

# 4. –ó–∞–ø—É—Å–∫–∞–µ–º
uvicorn app.main:app --reload
```

–û—Ç–∫—Ä–æ–π—Ç–µ [http://127.0.0.1:8000/upload](http://127.0.0.1:8000/upload) ‚Äî UI –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.
Swagger –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `/docs`.

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| Var                                  | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é       | –û–ø–∏—Å–∞–Ω–∏–µ                     |
| ------------------------------------ | ------------------ | ---------------------------- |
| `UPLOAD_DIR`                         | `./uploads`        | –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è RAW‚Äë—Ñ–∞–π–ª–æ–≤       |
| `CONFIG_DIR`                         | `./config`         | JSON‚Äë–∫–æ–Ω—Ñ–∏–≥–∏ –º–∞–ø–ø–∏–Ω–≥–∞        |
| `SENDER_ENDPOINT`                    | ¬†‚Äî                 | URL –≤–Ω–µ—à–Ω–µ–≥–æ API             |
| `ALLOWED_EXT`                        | `.csv,.xlsx,.json` | –°–ø–∏—Å–æ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π            |
| `DB_PATH`                            | `mapping.db`       | SQLite‚Äë—Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–æ–≤         |
| S3¬†vars¬†(`S3_ENDPOINT`, `S3_KEY`, ‚Ä¶) | ¬†‚Äî                 | –î–ª—è `upload.store_s3_object` |

---

## üìë¬†–û—Å–Ω–æ–≤–Ω—ã–µ API‚Äë—ç–Ω–¥–ø–æ–π–Ω—Ç—ã

| –ú–µ—Ç–æ–¥                       | URL                                   | –û–ø–∏—Å–∞–Ω–∏–µ |
| --------------------------- | ------------------------------------- | -------- |
| `POST /projects/`           | –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç, –≤–µ—Ä–Ω—É—Ç—å `api_key`     |          |
| `GET  /upload`              | –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (HTMX form) |          |
| `POST /upload/local`        | –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (multipart)            |          |
| `GET  /mapping?project_id=` | –ü–æ–ª—É—á–∏—Ç—å JSON‚Äë–∫–æ–Ω—Ñ–∏–≥ –º–∞–ø–ø–∏–Ω–≥–∞         |          |
| `POST /mapping`             | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥             |          |
| `POST /send/manual`         | –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞  |          |

> –í—Å–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ `X-PROJECT-ID` –∏ `X-API-KEY`.

---

## üß™¬†–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
pytest -q
```

*–ú–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `respx` –¥–ª—è –º–æ–∫–æ–≤ HTTP –∏ `pytest-asyncio` –¥–ª—è async‚Äë—Ç–µ—Å—Ç–æ–≤.*

---

## üõ†Ô∏è¬†–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

* **FastAPI**¬†(+ Uvicorn) ‚Äî REST & UI
* **pandas**¬†‚Äî —Ä–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
* **SQLAlchemy¬†2.x (async)**¬†‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ (SQLite)
* **httpx + backoff**¬†‚Äî –Ω–∞–¥—ë–∂–Ω—ã–µ HTTP‚Äë–∑–∞–ø—Ä–æ—Å—ã
* **structlog**¬†‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
* **HTMX + Pico.css**¬†‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ—Ä–æ–Ω—Ç –±–µ–∑ —Å–±–æ—Ä—â–∏–∫–∞

---

## ¬© 2025 ‚Äî Mapping¬†Service
