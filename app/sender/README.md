# Sender Module (app/sender)

Модуль `app/sender` отвечает за отправку подготовленных данных (обычно DataFrame в формате JSON) на внешний HTTP‑endpoint.
Он применяется на финальном этапе пайплайна после парсинга, маппинга и проверки качества.

## Назначение

* Отправка данных стороннему API
* Повторная отправка из UI при необходимости (ручной запуск)
* Ведение логов об успешной/неудачной отправке

---

## Структура

### `client.py`

Инкапсулирует HTTP‑взаимодействие через `httpx.AsyncClient` с поддержкой **backoff** (автоматических повторов при сетевых ошибках).

### `constants.py`

Содержит ключевые настройки и заголовки:

* `DEFAULT_ENDPOINT`: конечная точка API
* `HDR_PROJECT`, `HDR_APIKEY`: кастомные заголовки
* `DEFAULT_RETRIES`: число повторных попыток при ошибке

### `service.py`

Основная логика отправки:

* Принимает pandas.DataFrame + project\_id + api\_key
* Конвертирует в JSON
* Вызывает `client.send_json()`
* Возвращает результат в виде `SendResult`

### `schemas.py`

Pydantic‑модель результата отправки (успешно или с ошибкой).
Используется в сервисе и ручке.

### `router.py`

Маршрут `/send/manual`, вызываемый с UI.
Пытается найти **последний загруженный файл проекта** и повторно отправить его через `send_dataframe()`.

### `test_service.py`

Модульный тест, эмулирующий HTTP‑ответы от внешнего API, проверяет поведение при успехе и ошибке.
Используется библиотека `respx`.

---

## Пример работы

```python
# Пример использования внутри FastAPI endpoint
result = await send_dataframe(df, project_id, api_key)
if result.ok:
    print("Отправка успешна")
else:
    print("Ошибка при отправке", result.response)
```

---

## Зависимости

* httpx
* backoff
* pandas
* pydantic
* respx (для тестов)

---

## Примечания

* Все ошибки логируются через `structlog`
* В случае ошибок сеть/сервер, результат будет с `ok=False`, `status_code=0`, `attempts` будет отражать число попыток
* endpoint по умолчанию можно переопределить (например, в тестах)

---

## TODO

* Добавить поддержку других форматов кроме JSON?
* Добавить поддержку асинхронной очереди на отправку (например, Celery)
